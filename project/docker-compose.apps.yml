version: '3.8'

# =============================================================================
# Docker Compose for PaperDMS Applications
# =============================================================================
# This file deploys the JHipster microservices applications.
# Use docker-compose.yml for infrastructure (PostgreSQL, Kafka, etc.)
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.apps.yml up -d
#
# Or separately:
#   docker-compose up -d                        # Infrastructure
#   docker-compose -f docker-compose.apps.yml up -d  # Applications
# =============================================================================

services:
  # =============================================================================
  # documentService - Document Management Microservice
  # =============================================================================
  documentservice:
    image: paperdms/documentservice:latest
    container_name: paperdms-documentservice
    environment:
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=prod
      
      # Database Configuration
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgresql:5432/${DOCUMENTSERVICE_DB_NAME:-documentService}
      - SPRING_DATASOURCE_USERNAME=${DOCUMENTSERVICE_DB_USER:-documentService}
      - SPRING_DATASOURCE_PASSWORD=${DOCUMENTSERVICE_DB_PASSWORD:-documentService}
      
      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD:-}
      
      # Kafka Configuration
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      
      # Elasticsearch Configuration
      - SPRING_ELASTICSEARCH_URIS=http://elasticsearch:9200
      
      # Consul Configuration
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      
      # S3/MinIO Configuration
      - S3_BUCKET=${S3_BUCKET:-paperdms-documents}
      - S3_REGION=${S3_REGION:-us-east-1}
      - S3_ENDPOINT=${S3_ENDPOINT:-http://minio:9000}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:-minioadmin}
      - S3_SECRET_KEY=${S3_SECRET_KEY:-minioadmin}
      
      # Kafka Topics
      - KAFKA_DOCUMENT_EVENTS_TOPIC=${KAFKA_DOCUMENT_EVENTS_TOPIC:-paperdms.document.events}
      - KAFKA_SERVICE_STATUS_TOPIC=${KAFKA_SERVICE_STATUS_TOPIC:-paperdms.document.service-status}
      
      # JHipster Configuration
      - JHIPSTER_CACHE_REDIS_SERVER=redis://redis:6379
      - JHIPSTER_SECURITY_AUTHENTICATION_JWT_BASE64_SECRET=${JWT_SECRET:-NzhiYTRhNzdiNjc5ZDIzODNmMmYxODMyYTlhY2U4MWFkYTc0MmE0YmJlM2QyZTcyZTE0Y2UwODA4YjhmM2YwMTBjMjgxMTVhZjY4YjA1ODU5YWU3ZjMwNjNkZDM4NjkzMzQ2OWI1NDYzZGU2NTI5MjExNzhlNjEwYzUwY2NkYWM=}
      
      # Java Options
      - JAVA_OPTS=-Xmx512m -Xms256m
    ports:
      - "${DOCUMENTSERVICE_PORT:-8081}:8081"
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      consul:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - paperdms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/management/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # =============================================================================
  # gateway - API Gateway
  # =============================================================================
  gateway:
    image: paperdms/gateway:latest
    container_name: paperdms-gateway
    environment:
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=prod
      
      # Database Configuration
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgresql:5432/${GATEWAY_DB_NAME:-gateway}
      - SPRING_DATASOURCE_USERNAME=${GATEWAY_DB_USER:-gateway}
      - SPRING_DATASOURCE_PASSWORD=${GATEWAY_DB_PASSWORD:-gateway}
      
      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD:-}
      
      # Kafka Configuration
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      
      # Consul Configuration
      - SPRING_CLOUD_CONSUL_HOST=consul
      - SPRING_CLOUD_CONSUL_PORT=8500
      
      # JHipster Configuration
      - JHIPSTER_CACHE_REDIS_SERVER=redis://redis:6379
      - JHIPSTER_SECURITY_AUTHENTICATION_JWT_BASE64_SECRET=${JWT_SECRET:-NzhiYTRhNzdiNjc5ZDIzODNmMmYxODMyYTlhY2U4MWFkYTc0MmE0YmJlM2QyZTcyZTE0Y2UwODA4YjhmM2YwMTBjMjgxMTVhZjY4YjA1ODU5YWU3ZjMwNjNkZDM4NjkzMzQ2OWI1NDYzZGU2NTI5MjExNzhlNjEwYzUwY2NkYWM=}
      
      # Mail Configuration
      - SPRING_MAIL_HOST=${SPRING_MAIL_HOST:-maildev}
      - SPRING_MAIL_PORT=${SPRING_MAIL_PORT:-1025}
      - SPRING_MAIL_USERNAME=${SPRING_MAIL_USERNAME:-}
      - SPRING_MAIL_PASSWORD=${SPRING_MAIL_PASSWORD:-}
      - SPRING_MAIL_FROM=${SPRING_MAIL_FROM:-noreply@paperdms.local}
      - SPRING_MAIL_BASE_URL=${SPRING_MAIL_BASE_URL:-http://localhost:8080}
      
      # Java Options
      - JAVA_OPTS=-Xmx512m -Xms256m
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
      consul:
        condition: service_healthy
      documentservice:
        condition: service_healthy
    networks:
      - paperdms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/management/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

# =============================================================================
# Network Configuration
# =============================================================================
networks:
  paperdms-network:
    external: true
    # This network should be created by docker-compose.yml
    # If not, create it with: docker network create paperdms-network
