name: PaperDMS CI/CD Pipeline

# =============================================================================
# Déclencheurs
# =============================================================================
on:
  # Déclenchement sur push de tags (ex: v1.0.0, v1.2.3)
  push:
    tags:
      - 'v*.*.*'
      - 'release-*'
  
    branches:
      - main
      - develop
      - 'release/**'
  
  # Déclenchement sur pull request
  pull_request:
    branches:
      - main
      - develop
  
  # Déclenchement manuel
  workflow_dispatch:
    inputs:
      build_services:
        description: 'Services to build (comma-separated, leave empty for all)'
        required: false
        default: ''
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

# =============================================================================
# Variables d'environnement globales
# =============================================================================
env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'
  MAVEN_OPTS: '-Xmx3072m'
  DOCKER_BUILDKIT: 1
  
  # Liste des packages Maven communs à builder
  MAVEN_PACKAGES: 'paperdms-common'
  
  # Liste des services microservices à builder
  SERVICES: >-
    gateway
    documentService
    ocrService
    searchService
    aiService
    workflowService
    notificationService
    emailService
    invoiceService
    receiptService
    contractService
    reportService
    archiveService
    auditService
    backupService

# =============================================================================
# Jobs
# =============================================================================
jobs:
  # ===========================================================================
  # Job 1: Build Maven Packages (Shared Libraries)
  # ===========================================================================
  build-maven-packages:
    name: Build Maven Packages
    runs-on: ubuntu-latest
    
    steps:
      # -----------------------------------------------------------------------
      # Checkout du code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper versioning
      
      # -----------------------------------------------------------------------
      # Setup Java
      # -----------------------------------------------------------------------
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      # -----------------------------------------------------------------------
      # Extract version from tag
      # -----------------------------------------------------------------------
      - name: Extract version
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${GITHUB_SHA::8}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"
      
      # -----------------------------------------------------------------------
      # Build Maven packages
      # -----------------------------------------------------------------------
      - name: Build Maven Packages
        run: |
          echo "Building Maven packages: ${{ env.MAVEN_PACKAGES }}"
          
          # Convert comma-separated list to array
          IFS=',' read -ra PACKAGES <<< "${{ env.MAVEN_PACKAGES }}"
          
          for package in "${PACKAGES[@]}"; do
            package=$(echo "$package" | xargs)  # Trim whitespace
            echo "=========================================="
            echo "Building package: $package"
            echo "=========================================="
            
            cd "$package"
            
            # Build and install to local repository
            mvn clean install -DskipTests -Drevision=${{ steps.version.outputs.version }}
            
            cd ..
          done
      
      # -----------------------------------------------------------------------
      # Run tests on Maven packages
      # -----------------------------------------------------------------------
      - name: Test Maven Packages
        if: ${{ !inputs.skip_tests }}
        run: |
          IFS=',' read -ra PACKAGES <<< "${{ env.MAVEN_PACKAGES }}"
          
          for package in "${PACKAGES[@]}"; do
            package=$(echo "$package" | xargs)
            echo "Testing package: $package"
            
            cd "$package"
            mvn test
            cd ..
          done
      
      # -----------------------------------------------------------------------
      # Upload Maven artifacts (JAR files)
      # -----------------------------------------------------------------------
      - name: Upload Maven Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-packages
          path: |
            */target/*.jar
            !*/target/*-sources.jar
            !*/target/*-javadoc.jar
          retention-days: 7
      
      # -----------------------------------------------------------------------
      # Upload .m2 repository for services to use
      # -----------------------------------------------------------------------
      - name: Upload Maven Repository
        uses: actions/upload-artifact@v4
        with:
          name: maven-repository
          path: ~/.m2/repository/fr/smartprod/paperdms/
          retention-days: 7

  # ===========================================================================
  # Job 2: Build Services (Parallel)
  # ===========================================================================
  build-services:
    name: Build Service
    needs: build-maven-packages
    runs-on: ubuntu-latest
    
    strategy:
      # Build services in parallel
      matrix:
        service: 
          - gateway
          - documentService
          - ocrService
          - searchService
          - aiService
          - workflowService
          - notificationService
          - emailService
          - invoiceService
          - receiptService
          - contractService
          - reportService
          - archiveService
          - auditService
          - backupService
      
      # Continue building other services even if one fails
      fail-fast: false
      
      # Maximum 5 parallel jobs
      max-parallel: 5
    
    steps:
      # -----------------------------------------------------------------------
      # Checkout code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
      
      # -----------------------------------------------------------------------
      # Setup Java
      # -----------------------------------------------------------------------
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      # -----------------------------------------------------------------------
      # Setup Node.js (for gateway frontend)
      # -----------------------------------------------------------------------
      - name: Set up Node.js ${{ env.NODE_VERSION }}
        if: matrix.service == 'gateway'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.service }}/package-lock.json
      
      # -----------------------------------------------------------------------
      # Download Maven artifacts from previous job
      # -----------------------------------------------------------------------
      - name: Download Maven Repository
        uses: actions/download-artifact@v4
        with:
          name: maven-repository
          path: ~/.m2/repository/fr/smartprod/paperdms/
      
      # -----------------------------------------------------------------------
      # Extract version
      # -----------------------------------------------------------------------
      - name: Extract version
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${GITHUB_SHA::8}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building ${{ matrix.service }} version: ${VERSION}"
      
      # -----------------------------------------------------------------------
      # Install frontend dependencies (gateway only)
      # -----------------------------------------------------------------------
      - name: Install frontend dependencies
        if: matrix.service == 'gateway'
        working-directory: ${{ matrix.service }}
        run: npm ci
      
      # -----------------------------------------------------------------------
      # Build service
      # -----------------------------------------------------------------------
      - name: Build ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: |
          echo "=========================================="
          echo "Building service: ${{ matrix.service }}"
          echo "=========================================="
          
          # Build with production profile
          mvn clean package -Pprod -DskipTests -Drevision=${{ steps.version.outputs.version }}
      
      # -----------------------------------------------------------------------
      # Run tests
      # -----------------------------------------------------------------------
      - name: Test ${{ matrix.service }}
        if: ${{ !inputs.skip_tests }}
        working-directory: ${{ matrix.service }}
        run: mvn test
      
      # -----------------------------------------------------------------------
      # Upload JAR artifact
      # -----------------------------------------------------------------------
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-jar
          path: ${{ matrix.service }}/target/*.jar
          retention-days: 7
      
      # -----------------------------------------------------------------------
      # Login to Docker Hub (ONLY on tags)
      # -----------------------------------------------------------------------
      - name: Login to Docker Hub
        if: startsWith(github.ref, 'refs/tags/')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      # -----------------------------------------------------------------------
      # Set up Docker Buildx (ONLY on tags)
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        if: startsWith(github.ref, 'refs/tags/')
        uses: docker/setup-buildx-action@v3
      
      # -----------------------------------------------------------------------
      # Build and push Docker image (ONLY on tags)
      # -----------------------------------------------------------------------
      - name: Build and push Docker image
        if: startsWith(github.ref, 'refs/tags/')
        working-directory: ${{ matrix.service }}
        run: |
          echo "?? Building and pushing Docker image for tag ${GITHUB_REF#refs/tags/}"
          
          # Build with Jib
          mvn -Pprod compile jib:build \
            -Djib.to.image=paperdms/${{ matrix.service }}:${{ steps.version.outputs.version }} \
            -Djib.to.tags=latest \
            -Djib.to.auth.username=${{ secrets.DOCKER_USERNAME }} \
            -Djib.to.auth.password=${{ secrets.DOCKER_PASSWORD }}
      
      # -----------------------------------------------------------------------
      # Upload test results
      # -----------------------------------------------------------------------
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: ${{ matrix.service }}/target/surefire-reports/
          retention-days: 7

  # ===========================================================================
  # Job 3: Publish Release (Tags only)
  # ===========================================================================
  publish-release:
    name: Publish Release
    needs: [build-maven-packages, build-services]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    
    steps:
      # -----------------------------------------------------------------------
      # Checkout code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
      
      # -----------------------------------------------------------------------
      # Download all artifacts
      # -----------------------------------------------------------------------
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      # -----------------------------------------------------------------------
      # Extract version
      # -----------------------------------------------------------------------
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      # -----------------------------------------------------------------------
      # Create Release
      # -----------------------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Job 4: Build Summary
  # ===========================================================================
  build-summary:
    name: Build Summary
    needs: [build-maven-packages, build-services]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Summary
        run: |
          echo "# PaperDMS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch/Tag**: ${GITHUB_REF#refs/*/}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "- Maven Packages: ${{ needs.build-maven-packages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Services Build: ${{ needs.build-services.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Services Built" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.SERVICES }}" | tr ' ' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY