name: PaperDMS CI/CD (Optimized)

# =============================================================================
# Workflow optimisé avec:
# - Matrice Maven pour packages communs
# - Gestion intelligente des dépendances Maven
# - Cache Maven et npm
# - Build conditionnel avec retry
# - Docker layer caching
# =============================================================================

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

# =============================================================================
# Permissions (required for GHCR push)
# =============================================================================
permissions:
  contents: read      # For checkout
  packages: write     # For pushing Docker images to GHCR
  actions: read       # For downloading artifacts

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/paperdms

# =============================================================================
# Jobs
# =============================================================================
jobs:
  # ===========================================================================
  # Build Maven Packages - Phase 1 (No dependencies)
  # ===========================================================================
  build-maven-base:
    name: Build Maven Base (${{ matrix.package }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        package:
          - paperdms-common      # Base package (no dependencies)
          # Add more base packages here (packages with no internal dependencies)
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      # Cache Maven dependencies
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Extract version
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${GITHUB_SHA::8}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Build ${{ matrix.package }}
        id: build
        run: |
          cd ${{ matrix.package }}
          echo "Building ${{ matrix.package }}..."
          mvn clean install -DskipTests -Drevision=${{ steps.version.outputs.version }}
      
      # Retry on failure
      - name: Retry build on failure
        if: failure() && steps.build.outcome == 'failure'
        run: |
          echo "Retrying build for ${{ matrix.package }}..."
          cd ${{ matrix.package }}
          mvn clean install -DskipTests -Drevision=${{ steps.version.outputs.version }}
      
      - name: Test ${{ matrix.package }}
        run: |
          cd ${{ matrix.package }}
          mvn test
      
      # Upload artifacts for this specific package
      - name: Upload ${{ matrix.package }} artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-${{ matrix.package }}
          path: ~/.m2/repository/fr/smartprod/paperdms/
          retention-days: 1

  # ===========================================================================
  # Build Maven Packages - Phase 2 (Depends on Phase 1)
  # ===========================================================================
  build-maven-dependent:
    name: Build Maven Dependent (${{ matrix.package }})
    runs-on: ubuntu-latest
    needs: build-maven-base
    if: always() && needs.build-maven-base.result != 'failure'
    
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        package:
          # Add packages that depend on paperdms-common here
          # Example:
          # - paperdms-shared
          # - paperdms-dto
          # - paperdms-domain
        include: []  # Empty for now, add when you have dependent packages
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      # Cache Maven dependencies
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      # Download all base packages
      - name: Download base Maven packages
        uses: actions/download-artifact@v4
        with:
          pattern: maven-*
          path: ~/.m2/repository/fr/smartprod/paperdms/
          merge-multiple: true
      
      - name: Extract version
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${GITHUB_SHA::8}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Build ${{ matrix.package }}
        id: build
        run: |
          cd ${{ matrix.package }}
          echo "Building ${{ matrix.package }} (depends on base packages)..."
          mvn clean install -DskipTests -Drevision=${{ steps.version.outputs.version }}
      
      # Retry on failure
      - name: Retry build on failure
        if: failure() && steps.build.outcome == 'failure'
        run: |
          echo "Retrying build for ${{ matrix.package }}..."
          cd ${{ matrix.package }}
          mvn clean install -DskipTests -Drevision=${{ steps.version.outputs.version }}
      
      - name: Test ${{ matrix.package }}
        run: |
          cd ${{ matrix.package }}
          mvn test
      
      # Upload artifacts
      - name: Upload ${{ matrix.package }} artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-${{ matrix.package }}
          path: ~/.m2/repository/fr/smartprod/paperdms/
          retention-days: 1

  # ===========================================================================
  # Consolidate Maven Artifacts
  # ===========================================================================
  consolidate-maven:
    name: Consolidate Maven Artifacts
    runs-on: ubuntu-latest
    needs: [build-maven-base, build-maven-dependent]
    if: always() && (needs.build-maven-base.result == 'success' || needs.build-maven-dependent.result == 'success')
    
    steps:
      - name: Download all Maven artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: maven-*
          path: maven-temp/
      
      - name: Consolidate artifacts
        run: |
          mkdir -p ~/.m2/repository/fr/smartprod/paperdms/
          
          # Merge all maven artifacts into one
          if [ -d "maven-temp" ]; then
            find maven-temp -type f -exec cp --parents {} ~/.m2/repository/fr/smartprod/paperdms/ \; 2>/dev/null || true
            
            # Alternative: use rsync if available
            rsync -av maven-temp/ ~/.m2/repository/fr/smartprod/paperdms/ 2>/dev/null || \
              cp -r maven-temp/* ~/.m2/repository/fr/smartprod/paperdms/ 2>/dev/null || true
          fi
          
          echo "Consolidated Maven repository:"
          find ~/.m2/repository/fr/smartprod/paperdms/ -type f | head -20
      
      - name: Upload consolidated Maven repository
        uses: actions/upload-artifact@v4
        with:
          name: maven-repository-complete
          path: ~/.m2/repository/fr/smartprod/paperdms/
          retention-days: 1

  # ===========================================================================
  # Build Services Matrix
  # ===========================================================================
  build-services:
    name: Build ${{ matrix.service }}
    needs: consolidate-maven
    runs-on: ubuntu-latest
    
    # Build if Maven consolidation succeeded
    if: always() && needs.consolidate-maven.result == 'success'
    
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        include:
          - service: gateway
            needs-node: true
          - service: aiService
            needs-node: false
          - service: archiveService
            needs-node: false
          - service: documentService
            needs-node: false
          - service: emailImportService
            needs-node: false
          - service: exportService
            needs-node: false
          - service: monitoringService
            needs-node: false
          - service: notificationService
            needs-node: false
          - service: ocrService
            needs-node: false
          - service: reportingService
            needs-node: false
          - service: searchService
            needs-node: false
          - service: similarityService
            needs-node: false
          - service: transformService
            needs-node: false
          - service: workflowService
            needs-node: false
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: Set up Node.js
        if: matrix.needs-node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # Restore Maven cache
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      # Cache npm dependencies
      - name: Cache npm packages
        if: matrix.needs-node
        uses: actions/cache@v3
        with:
          path: ${{ matrix.service }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles(format('{0}/package-lock.json', matrix.service)) }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      # Download consolidated Maven repository
      - name: Download Maven Repository
        uses: actions/download-artifact@v4
        with:
          name: maven-repository-complete
          path: ~/.m2/repository/fr/smartprod/paperdms/
      
      - name: Extract version
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${GITHUB_SHA::8}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Install frontend dependencies
        if: matrix.needs-node
        working-directory: ${{ matrix.service }}
        run: npm ci
      
      - name: Build ${{ matrix.service }}
        id: build
        working-directory: ${{ matrix.service }}
        run: mvn clean package -Pprod -DskipTests
      
      # Retry build on failure
      - name: Retry build on failure
        if: failure() && steps.build.outcome == 'failure'
        working-directory: ${{ matrix.service }}
        run: |
          echo "Retrying build for ${{ matrix.service }}..."
          mvn clean package -Pprod -DskipTests
      
      - name: Test ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: mvn test
      
      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-jar
          path: ${{ matrix.service }}/target/*.jar
          retention-days: 7
      
      # Docker build and push (ONLY on tags)
      - name: Set up Docker Buildx
        if: startsWith(github.ref, 'refs/tags/')
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        if: startsWith(github.ref, 'refs/tags/')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        if: startsWith(github.ref, 'refs/tags/')
        working-directory: ${{ matrix.service }}
        run: |
          echo "?? Building and pushing Docker image for tag ${GITHUB_REF#refs/tags/}"
          
          # Convert service name to lowercase for Docker image name
          SERVICE_LOWER=$(echo "${{ matrix.service }}" | tr '[:upper:]' '[:lower:]')
          
          mvn -Pprod compile jib:build \
            -Djib.to.image=ghcr.io/${{ github.repository_owner }}/paperdms-${SERVICE_LOWER}:${{ steps.version.outputs.version }} \
            -Djib.to.tags=latest \
            -Djib.to.auth.username=${{ github.actor }} \
            -Djib.to.auth.password=${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Create Release
  # ===========================================================================
  create-release:
    name: Create Release
    needs: build-services
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: artifacts/**/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}